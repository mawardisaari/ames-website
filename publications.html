<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Publications – AMES</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Poppins', sans-serif; background:#f2f4f7; margin:0; color:#222; }
    nav { position: sticky; top: 0; z-index: 100; background: #fff; padding: 15px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); display: flex; justify-content: center; gap: 30px; }
    nav a { text-decoration: none; color: #003366; font-weight: 600; transition: 0.3s; }
    nav a:hover { color: #0078c8; }
    h1 { text-align:center; color:#003366; margin:40px 20px 20px; }
    .card { background:#fff; padding:20px 25px; border-radius:14px; box-shadow:0 4px 20px rgba(0,0,0,0.08); max-width:1000px; margin:20px auto 40px; }
    
    .researcher-section { margin-bottom: 25px; border: 1px solid #e1e8ed; border-radius: 10px; overflow: hidden; }
    .researcher-header { 
      background: linear-gradient(135deg, #003366 0%, #0078c8 100%); 
      color: white; padding: 18px 25px; cursor: pointer; 
      font-weight: 600; font-size: 16px; transition: 0.3s;
      display: flex; justify-content: space-between; align-items: center;
    }
    .researcher-header:hover { background: linear-gradient(135deg, #002855 0%, #0066aa 100%); }
    .researcher-toggle { font-size: 20px; transition: transform 0.3s; }
    .researcher-toggle.active { transform: rotate(180deg); }
    
    .pubs-container { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out; }
    .pubs-container.active { max-height: 2000px; padding: 20px 25px; background: #f8f9fa; }
    
    .year-block { margin-bottom: 20px; }
    .year-title { font-weight:700; font-size:16px; color:#003366; border-bottom:2px solid #0078c8; padding-bottom:4px; margin-bottom:10px; }
    .pub-item { margin:6px 0; line-height:1.5; }
    .pub-index { font-weight:600; margin-right:6px; color:#0078c8; }
    .doi-link { color:#c0392b; text-decoration:none; font-weight:600; }
    .doi-link:hover { text-decoration:underline; }
    
    footer { text-align: center; padding: 25px; background: #003366; color: #fff; margin-top: 40px; }
  </style>
</head>
<body>
  <nav>
    <a href="index.html">Home</a>
    <a href="researchers.html">Researchers</a>
    <a href="publications.html">Publications</a>
    <a href="projects.html">Projects</a>
    <a href="news.html">News</a>
    <a href="contact.html">Contact</a>
  </nav>

  <h1>Publications</h1>
  <div class="card">
    <p id="loading">Loading publications…</p>
    <div id="researchers-container"></div>
  </div>

  <footer>© 2025 Advanced Metrology and Sensing Group (AMES)</footer>

  <script>
    // ✅ YOUR 3 CSV FILES - UPLOAD TO GITHUB FIRST!
    const RESEARCHERS = [
      {
        name: 'Mohd Mawardi Saari',
        csv: 'https://raw.githubusercontent.com/mawardisaari/ames-website/main/scopus-mawardi.csv',
        scopusId: '57220107330'
      },
      {
        name: 'Nurul A\'in Nadzri',
        csv: 'https://raw.githubusercontent.com/mawardisaari/ames-website/main/scopus-nurulain.csv',
        scopusId: '57201859397'
      },
      {
        name: 'Yasmin Abdul Wahab',
        csv: 'https://raw.githubusercontent.com/mawardisaari/ames-website/main/scopus-yasmin.csv',
        scopusId: '57203353903'
      }
    ];

    async function loadAllPublications() {
      const container = document.getElementById('researchers-container');
      const loadingEl = document.getElementById('loading');
      
      for (const researcher of RESEARCHERS) {
        try {
          console.log(`Loading ${researcher.name}...`);
          const res = await fetch(researcher.csv);
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          
          const text = await res.text();
          const pubs = parseScopusCSV(text);
          console.log(`${researcher.name}: ${pubs.length} publications`);
          
          renderResearcherSection(container, researcher, pubs);
          
        } catch (err) {
          console.error(`Failed ${researcher.name}:`, err);
          container.innerHTML += `<div class="researcher-section">
            <div class="researcher-header">
              <span>${researcher.name} <small style="color:#ff6b6b;">(Failed to load)</small></span>
            </div>
          </div>`;
        }
      }
      
      if (container.children.length === 0) {
        loadingEl.textContent = 'No publications loaded. Check CSV files.';
      } else {
        loadingEl.style.display = 'none';
      }
    }

    function renderResearcherSection(container, researcher, pubs) {
      const section = document.createElement('div');
      section.className = 'researcher-section';
      section.innerHTML = `
        <div class="researcher-header" onclick="toggleResearcher(this)">
          <span>${researcher.name} <small style="opacity:0.8;">(${pubs.length} pubs)</small></span>
          <span class="researcher-toggle">▼</span>
        </div>
        <div class="pubs-container">
          ${renderPublicationsHTML(pubs, researcher.scopusId)}
        </div>
      `;
      container.appendChild(section);
    }

    function toggleResearcher(header) {
      const section = header.parentElement;
      const container = section.querySelector('.pubs-container');
      const toggle = header.querySelector('.researcher-toggle');
      
      container.classList.toggle('active');
      toggle.classList.toggle('active');
    }

    function parseScopusCSV(csvText) {
      csvText = csvText.replace(/^\uFEFF/, '');
      const lines = csvText.split(/\r?\n/).filter(l => l.trim());
      if (lines.length < 2) return [];

      const header = splitCSVLine(lines[0]);
      const idx = {};
      header.forEach((h, i) => {
        const key = h.trim().toLowerCase();
        idx[key] = i;
      });

      const pubs = [];
      for (let i = 1; i < lines.length; i++) {
        const cols = splitCSVLine(lines[i]);
        if (!cols.length || !cols[idx['title']]?.trim()) continue;

        pubs.push({
          authors: (cols[idx['authors']] || '').trim(),
          title: (cols[idx['title']] || '').trim(),
          year: (cols[idx['year']] || '').trim(),
          sourceTitle: (cols[idx['source title']] || '').trim(),
          volume: (cols[idx['volume']] || '').trim(),
          issue: (cols[idx['issue']] || '').trim(),
          artNo: (cols[idx['art. no.']] || '').trim(),
          pageStart: (cols[idx['page start']] || '').trim(),
          pageEnd: (cols[idx['page end']] || '').trim(),
          doi: (cols[idx['doi']] || '').trim()
        });
      }
      return pubs;
    }

    function splitCSVLine(line) {
      const result = [];
      let current = '';
      let inQuotes = false;
      for (let i = 0; i < line.length; i++) {
        const ch = line[i];
        if (ch === '"') {
          if (inQuotes && line[i+1] === '"') {
            current += '"';
            i++;
          } else {
            inQuotes = !inQuotes;
          }
        } else if (ch === ',' && !inQuotes) {
          result.push(current);
          current = '';
        } else {
          current += ch;
        }
      }
      result.push(current);
      return result;
    }

    function renderPublicationsHTML(pubs, myScopusId) {
      const byYear = {};
      pubs.forEach(p => {
        const y = p.year || 'N/A';
        if (!byYear[y]) byYear[y] = [];
        byYear[y].push(p);
      });

      const years = Object.keys(byYear).sort((a,b) => (b || 0) - (a || 0));
      let html = '';
      
      years.forEach(year => {
        html += `<div class="year-block"><div class="year-title">${year}</div>`;
        byYear[year].forEach((p, idx) => {
          const citation = formatIEEE(p, myScopusId);
          html += `<div class="pub-item"><span class="pub-index">[${idx+1}]</span>${citation}</div>`;
        });
        html += '</div>';
      });
      
      return html || '<p>No publications found.</p>';
    }

    function formatIEEE(p, myScopusId) {
      let authors = p.authors || '';
      // Bold researcher's name based on Scopus ID
      authors = authors.replace(new RegExp(myScopusId, 'gi'), `<b>$&</b>`);
      
      const title = p.title || '';
      const source = p.sourceTitle || '';
      const year = p.year || '';
      const vol = p.volume ? `, vol. ${p.volume}` : '';
      const iss = p.issue ? `, no. ${p.issue}` : '';
      let pages = p.pageStart && p.pageEnd ? `, pp. ${p.pageStart}–${p.pageEnd}` : '';
      const artNo = p.artNo ? `, Art. no. ${p.artNo}` : '';
      const doiPart = p.doi ? ` <a class="doi-link" href="https://doi.org/${p.doi}" target="_blank">[${p.doi}]</a>` : '';

      return `${authors}, "${title}", <i>${source}</i>${vol}${iss}${pages}${artNo}, ${year}${doiPart}.`;
    }

    window.onload = loadAllPublications;
  </script>
</body>
</html>
